sequenceDiagram
    autonumber
    
    participant PS as Proceso<br/>Solicitante
    participant GC as Gestor<br/>Carga
    participant AD as Actor<br/>DevoluciÃ³n
    participant AR as Actor<br/>RenovaciÃ³n
    participant AP as Actor<br/>PrÃ©stamo
    participant BD as Base de<br/>Datos
    
    Note over PS,BD: ğŸš€ FASE 1: INICIALIZACIÃ“N
    
    rect rgb(230, 240, 255)
        Note over PS: Leer peticiones.txt<br/>(20+ operaciones)
        Note over GC: Escuchar puerto 5555 (REP)<br/>Publicar puerto 5556 (PUB)
        Note over AD: Suscrito tÃ³pico<br/>DEVOLUCION
        Note over AR: Suscrito tÃ³pico<br/>RENOVACION
        Note over AP: Socket REP puerto 5559<br/>(comunicaciÃ³n sÃ­ncrona)
        Note over BD: MySQL iniciado<br/>1000 libros cargados
    end
    
    Note over PS,BD: ğŸ“¤ OPERACIÃ“N 1: DEVOLUCIÃ“N (ASÃNCRONA)
    
    rect rgb(255, 250, 245)
        PS->>GC: â‘  REQ: DEVOLUCION|LIB00001|USR1001
        Note right of GC: Respuesta<br/>inmediata
        GC-->>PS: â‘¡ REP: OK - "Biblioteca recibiendo libro"
        Note left of PS: âœ“ Cliente continÃºa<br/>(~2ms)
        
        GC->>AD: â‘¢ PUB: DEVOLUCION {libro, usuario}
        
        AD->>BD: â‘£ UPDATE libros<br/>ejemplares_disponibles += 1
        AD->>BD: â‘¤ INSERT historial_operaciones
        Note right of BD: âœ“ BD actualizada<br/>en background<br/>(~50ms despuÃ©s)
    end
    
    Note over PS,BD: ğŸ”„ OPERACIÃ“N 2: RENOVACIÃ“N (ASÃNCRONA)
    
    rect rgb(245, 255, 245)
        PS->>GC: â‘¥ REQ: RENOVACION|LIB00025|USR2002
        Note right of GC: Calcular<br/>nueva_fecha
        GC-->>PS: â‘¦ REP: OK - "Nueva fecha: 2025-10-13"
        Note left of PS: âœ“ Fecha recibida<br/>(~3ms)
        
        GC->>AR: â‘§ PUB: RENOVACION {libro, nueva_fecha}
        
        AR->>BD: â‘¨ UPDATE prestamos<br/>fecha_entrega = nueva_fecha<br/>renovaciones += 1
        AR->>BD: â‘© INSERT historial_operaciones
        Note right of BD: âœ“ RenovaciÃ³n<br/>registrada
    end
    
    Note over PS,BD: ğŸ”’ OPERACIÃ“N 3: PRÃ‰STAMO (SÃNCRONA)
    
    rect rgb(255, 245, 255)
        PS->>GC: â‘ª REQ: PRESTAMO|LIB00300|USR3001
        Note right of GC: Espera respuesta<br/>de Actor
        
        GC->>AP: â‘« REQ: Verificar y otorgar
        
        AP->>BD: â‘¬ SELECT ejemplares_disponibles
        BD-->>AP: â‘­ ejemplares = 2 (disponible)
        
        AP->>BD: â‘® BEGIN TRANSACTION
        AP->>BD: â‘¯ UPDATE libros (ejemplares -= 1)
        AP->>BD: â‘° INSERT prestamos (nuevo prÃ©stamo)
        AP->>BD: â‘± INSERT historial_operaciones
        AP->>BD: â‘² COMMIT
        
        AP-->>GC: â‘³ REP: OK - "PrÃ©stamo otorgado"
        GC-->>PS: ã‰‘ REP: OK - "Fecha entrega: 2025-10-20"
        Note left of PS: âœ“ ConfirmaciÃ³n<br/>BD actualizada<br/>(~70ms)
    end
    
    Note over PS,BD: ğŸ” OPERACIONES 4-24 (MÃšLTIPLES)
    
    rect rgb(250, 250, 250)
        loop Peticiones restantes (4 a 24)
            
            alt DEVOLUCIÃ“N (AsÃ­ncrona)
                PS->>GC: REQ: DEVOLUCION
                GC-->>PS: REP: OK (inmediato)
                GC->>AD: PUB
                AD->>BD: UPDATE (background)
                
            else RENOVACIÃ“N (AsÃ­ncrona)
                PS->>GC: REQ: RENOVACION
                GC-->>PS: REP: OK + fecha (inmediato)
                GC->>AR: PUB
                AR->>BD: UPDATE (background)
                
            else PRÃ‰STAMO (SÃ­ncrona)
                PS->>GC: REQ: PRESTAMO
                GC->>AP: REQ
                AP->>BD: SELECT + TRANSACCIÃ“N
                AP-->>GC: REP
                GC-->>PS: REP (despuÃ©s de BD)
            end
            
            Note over PS: Delay 0.5s<br/>entre peticiones
        end
    end
    
    Note over PS,BD: ğŸ“Š FASE FINAL: RESUMEN
    
    rect rgb(245, 245, 250)
        Note over PS: â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•<br/>RESUMEN EJECUCIÃ“N<br/>â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•<br/>Total: 24 peticiones<br/>Devoluciones: 8<br/>Renovaciones: 8<br/>PrÃ©stamos: 8<br/><br/>Exitosas: 22 âœ“<br/>Fallidas: 2 âœ—<br/>â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        Note over BD: ESTADO FINAL BD<br/>â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•<br/>â€¢ Ejemplares actualizados<br/>â€¢ 8 nuevos prÃ©stamos<br/>â€¢ 8 renovaciones<br/>â€¢ 8 devoluciones<br/>â€¢ 24 registros en historial<br/>â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        Note over PS,AP: ğŸ”‘ DIFERENCIAS CLAVE:<br/>ASÃNCRONA: Cliente no espera BD (~2-5ms)<br/>SÃNCRONA: Cliente espera BD (~70-100ms)
    end
