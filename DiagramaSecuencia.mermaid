sequenceDiagram
    autonumber
    
    participant PS as Proceso<br/>Solicitante
    participant GC as Gestor<br/>Carga
    participant AD as Actor<br/>Devolución
    participant AR as Actor<br/>Renovación
    participant AP as Actor<br/>Préstamo
    participant BD as Base de<br/>Datos
    
    Note over PS,BD: 🚀 FASE 1: INICIALIZACIÓN
    
    rect rgb(230, 240, 255)
        Note over PS: Leer peticiones.txt<br/>(20+ operaciones)
        Note over GC: Escuchar puerto 5555 (REP)<br/>Publicar puerto 5556 (PUB)
        Note over AD: Suscrito tópico<br/>DEVOLUCION
        Note over AR: Suscrito tópico<br/>RENOVACION
        Note over AP: Socket REP puerto 5559<br/>(comunicación síncrona)
        Note over BD: MySQL iniciado<br/>1000 libros cargados
    end
    
    Note over PS,BD: 📤 OPERACIÓN 1: DEVOLUCIÓN (ASÍNCRONA)
    
    rect rgb(255, 250, 245)
        PS->>GC: ① REQ: DEVOLUCION|LIB00001|USR1001
        Note right of GC: Respuesta<br/>inmediata
        GC-->>PS: ② REP: OK - "Biblioteca recibiendo libro"
        Note left of PS: ✓ Cliente continúa<br/>(~2ms)
        
        GC->>AD: ③ PUB: DEVOLUCION {libro, usuario}
        
        AD->>BD: ④ UPDATE libros<br/>ejemplares_disponibles += 1
        AD->>BD: ⑤ INSERT historial_operaciones
        Note right of BD: ✓ BD actualizada<br/>en background<br/>(~50ms después)
    end
    
    Note over PS,BD: 🔄 OPERACIÓN 2: RENOVACIÓN (ASÍNCRONA)
    
    rect rgb(245, 255, 245)
        PS->>GC: ⑥ REQ: RENOVACION|LIB00025|USR2002
        Note right of GC: Calcular<br/>nueva_fecha
        GC-->>PS: ⑦ REP: OK - "Nueva fecha: 2025-10-13"
        Note left of PS: ✓ Fecha recibida<br/>(~3ms)
        
        GC->>AR: ⑧ PUB: RENOVACION {libro, nueva_fecha}
        
        AR->>BD: ⑨ UPDATE prestamos<br/>fecha_entrega = nueva_fecha<br/>renovaciones += 1
        AR->>BD: ⑩ INSERT historial_operaciones
        Note right of BD: ✓ Renovación<br/>registrada
    end
    
    Note over PS,BD: 🔒 OPERACIÓN 3: PRÉSTAMO (SÍNCRONA)
    
    rect rgb(255, 245, 255)
        PS->>GC: ⑪ REQ: PRESTAMO|LIB00300|USR3001
        Note right of GC: Espera respuesta<br/>de Actor
        
        GC->>AP: ⑫ REQ: Verificar y otorgar
        
        AP->>BD: ⑬ SELECT ejemplares_disponibles
        BD-->>AP: ⑭ ejemplares = 2 (disponible)
        
        AP->>BD: ⑮ BEGIN TRANSACTION
        AP->>BD: ⑯ UPDATE libros (ejemplares -= 1)
        AP->>BD: ⑰ INSERT prestamos (nuevo préstamo)
        AP->>BD: ⑱ INSERT historial_operaciones
        AP->>BD: ⑲ COMMIT
        
        AP-->>GC: ⑳ REP: OK - "Préstamo otorgado"
        GC-->>PS: ㉑ REP: OK - "Fecha entrega: 2025-10-20"
        Note left of PS: ✓ Confirmación<br/>BD actualizada<br/>(~70ms)
    end
    
    Note over PS,BD: 🔁 OPERACIONES 4-24 (MÚLTIPLES)
    
    rect rgb(250, 250, 250)
        loop Peticiones restantes (4 a 24)
            
            alt DEVOLUCIÓN (Asíncrona)
                PS->>GC: REQ: DEVOLUCION
                GC-->>PS: REP: OK (inmediato)
                GC->>AD: PUB
                AD->>BD: UPDATE (background)
                
            else RENOVACIÓN (Asíncrona)
                PS->>GC: REQ: RENOVACION
                GC-->>PS: REP: OK + fecha (inmediato)
                GC->>AR: PUB
                AR->>BD: UPDATE (background)
                
            else PRÉSTAMO (Síncrona)
                PS->>GC: REQ: PRESTAMO
                GC->>AP: REQ
                AP->>BD: SELECT + TRANSACCIÓN
                AP-->>GC: REP
                GC-->>PS: REP (después de BD)
            end
            
            Note over PS: Delay 0.5s<br/>entre peticiones
        end
    end
    
    Note over PS,BD: 📊 FASE FINAL: RESUMEN
    
    rect rgb(245, 245, 250)
        Note over PS: ═══════════════════<br/>RESUMEN EJECUCIÓN<br/>═══════════════════<br/>Total: 24 peticiones<br/>Devoluciones: 8<br/>Renovaciones: 8<br/>Préstamos: 8<br/><br/>Exitosas: 22 ✓<br/>Fallidas: 2 ✗<br/>═══════════════════
        
        Note over BD: ESTADO FINAL BD<br/>═══════════════════<br/>• Ejemplares actualizados<br/>• 8 nuevos préstamos<br/>• 8 renovaciones<br/>• 8 devoluciones<br/>• 24 registros en historial<br/>═══════════════════
        
        Note over PS,AP: 🔑 DIFERENCIAS CLAVE:<br/>ASÍNCRONA: Cliente no espera BD (~2-5ms)<br/>SÍNCRONA: Cliente espera BD (~70-100ms)
    end
