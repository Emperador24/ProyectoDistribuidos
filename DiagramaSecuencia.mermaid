sequenceDiagram
    autonumber
    
    participant PS as Proceso<br/>Solicitante
    participant GC as Gestor<br/>Carga
    participant AD as Actor<br/>Devoluci√≥n
    participant AR as Actor<br/>Renovaci√≥n
    participant AP as Actor<br/>Pr√©stamo
    participant GA as Gestor<br/>Almacenamiento
    participant BD as BD<br/>Principal
    participant BR as BD<br/>R√©plica
    
    Note over PS,BR: üöÄ INICIALIZACI√ìN DEL SISTEMA
    
    rect rgb(230, 240, 255)
        Note over PS: Cargar archivo<br/>peticiones.txt
        Note over GC: Bind REP:5555<br/>Connect REQ a Actores
        Note over AD: Bind REP:5556
        Note over AR: Bind REP:5557
        Note over AP: Bind REP:5559
        Note over GA: Iniciar pool<br/>conexiones BD
        Note over BD,BR: Ambas con<br/>1000 libros
    end
    
    Note over PS,BR: üì§ OPERACI√ìN 1: DEVOLUCI√ìN (S√çNCRONA)
    
    rect rgb(255, 250, 245)
        PS->>GC: REQ: DEVOLUCION|LIB001|USR1001
        Note right of GC: Espera respuesta<br/>del Actor
        
        GC->>AD: REQ: Procesar DEVOLUCION
        Note right of AD: Procesamiento<br/>s√≠ncrono
        
        AD->>GA: REQ: UPDATE_DEVOLUCION
        GA->>BD: UPDATE libros SET ejemplares+=1
        BD-->>GA: OK
        GA-->>AD: REP: Confirmaci√≥n
        
        AD->>GA: REQ: INSERT_HISTORIAL
        GA->>BD: INSERT INTO historial_operaciones
        BD-->>GA: OK
        GA-->>AD: REP: OK
        
        Note over GA,BR: Replicaci√≥n async
        GA->>BR: Replicar cambios
        BR-->>GA: ACK (async)
        
        AD-->>GC: REP: OK "Devoluci√≥n exitosa"
        GC-->>PS: REP: OK "Biblioteca recibi√≥ libro"
        Note left of PS: BD actualizada<br/>~40-80ms
    end
    
    Note over PS,BR: üîÑ OPERACI√ìN 2: RENOVACI√ìN (S√çNCRONA)
    
    rect rgb(245, 255, 245)
        PS->>GC: REQ: RENOVACION|LIB025|USR2002
        Note right of GC: Calcular nueva_fecha<br/>Espera respuesta Actor
        
        GC->>AR: REQ: Procesar RENOVACION
        
        AR->>GA: REQ: UPDATE_RENOVACION
        GA->>BD: UPDATE prestamos SET fecha_entrega, renovaciones+=1
        BD-->>GA: OK (si renovaciones<2)
        GA-->>AR: REP: Confirmaci√≥n
        
        AR->>GA: REQ: INSERT_HISTORIAL
        GA->>BD: INSERT INTO historial_operaciones
        BD-->>GA: OK
        GA-->>AR: REP: OK
        
        GA->>BR: Replicar cambios
        BR-->>GA: ACK (async)
        
        AR-->>GC: REP: OK "Renovaci√≥n exitosa"
        GC-->>PS: REP: OK "Nueva fecha: 2025-10-13"
        Note left of PS: BD actualizada<br/>~40-80ms
    end
    
    Note over PS,BR: üîí OPERACI√ìN 3: PR√âSTAMO (S√çNCRONA)
    
    rect rgb(255, 245, 255)
        PS->>GC: REQ: PRESTAMO|LIB300|USR3001
        Note right of GC: Espera<br/>respuesta Actor
        
        GC->>AP: REQ: Verificar y otorgar LIB300
        
        AP->>GA: REQ: SELECT_DISPONIBILIDAD
        GA->>BD: SELECT FROM libros WHERE codigo='LIB300'
        BD-->>GA: ejemplares=2
        GA-->>AP: REP: Disponibles: 2
        
        alt Libro disponible (ejemplares > 0)
            AP->>GA: REQ: TRANSACCION_PRESTAMO
            GA->>BD: START TRANSACTION
            
            GA->>BD: UPDATE libros SET ejemplares-=1
            BD-->>GA: OK
            
            GA->>BD: INSERT INTO prestamos
            BD-->>GA: OK
            
            GA->>BD: INSERT INTO historial_operaciones
            BD-->>GA: OK
            
            GA->>BD: COMMIT TRANSACTION
            BD-->>GA: Transacci√≥n exitosa
            GA-->>AP: REP: Confirmaci√≥n
            
            Note over GA,BR: Replicar despu√©s<br/>de COMMIT
            GA->>BR: Replicar transacci√≥n completa
            BR-->>GA: ACK (async)
            
            AP-->>GC: REP: OK "Pr√©stamo otorgado"
            GC-->>PS: REP: OK "Fecha entrega: 2025-10-20"
            Note left of PS: BD actualizada<br/>~80ms
            
        else Sin ejemplares disponibles
            AP->>GA: No iniciar transacci√≥n
            AP-->>GC: REP: ERROR "Sin ejemplares"
            GC-->>PS: REP: ERROR "No disponible"
            Note left of PS: Rechazo<br/>~40ms
        end
    end
    
    Note over PS,BR: ‚ö†Ô∏è ESCENARIO DE FALLA: BD PRINCIPAL
    
    rect rgb(255, 240, 240)
        AD->>GA: REQ: Solicitar UPDATE
        GA->>BD: Intentar conexi√≥n
        Note right of BD: BD Principal<br/>NO RESPONDE
        BD--xGA: Connection timeout/refused
        
        Note over GA: Health Check<br/>detecta falla<br/>Activar FAILOVER
        
        GA->>GA: switch_to_replica()
        Note right of GA: GA configura<br/>BD R√©plica como<br/>primaria
        
        GA->>BR: Establecer nueva conexi√≥n
        BR-->>GA: Conexi√≥n OK (ahora es primaria)
        GA-->>AD: REP: Conexi√≥n lista, reintentar
        
        AD->>GA: REQ: Reintentar UPDATE
        GA->>BR: UPDATE libros
        BR-->>GA: OK
        GA-->>AD: REP: Confirmaci√≥n
        
        Note over BD,BR: BD R√©plica ahora es PRINCIPAL<br/>BD Principal INACTIVA
        
        Note over BD: Cuando se recupere<br/>sincronizar desde<br/>R√©plica (ahora principal)
    end
    
    Note over PS,BR: üìä RESUMEN FINAL
    
    rect rgb(245, 245, 250)
        Note over PS: 3 operaciones enviadas:<br/>‚Ä¢ Devoluci√≥n (~40-80ms)<br/>‚Ä¢ Renovaci√≥n (~40-80ms)<br/>‚Ä¢ Pr√©stamo (~80ms)<br/>TODAS S√çNCRONAS
        
        Note over GC: Routing de mensajes:<br/>‚Ä¢ REQ/REP con cada Actor<br/>‚Ä¢ Espera respuesta de Actor<br/>‚Ä¢ Luego responde a PS
        
        Note over AD,AR: Procesamiento s√≠ncrono:<br/>‚Ä¢ Cliente espera<br/>‚Ä¢ BD actualizada antes de responder<br/>‚Ä¢ Garant√≠a de consistencia
        
        Note over AP: Procesamiento s√≠ncrono:<br/>‚Ä¢ Cliente espera<br/>‚Ä¢ Transacci√≥n ACID completa<br/>‚Ä¢ Confirmaci√≥n inmediata
        
        Note over GA: Gesti√≥n de BD:<br/>‚Ä¢ Pool conexiones<br/>‚Ä¢ Health checks<br/>‚Ä¢ Failover autom√°tico
        
        Note over BD,BR: Replicaci√≥n:<br/>‚Ä¢ As√≠ncrona<br/>‚Ä¢ Eventual consistency<br/>‚Ä¢ Tolerancia a fallos
    end
