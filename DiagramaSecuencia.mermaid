sequenceDiagram
    autonumber
    
    participant PS as Proceso<br/>Solicitante
    participant GC as Gestor<br/>Carga
    participant AD as Actor<br/>Devoluci√≥n
    participant AR as Actor<br/>Renovaci√≥n
    participant AP as Actor<br/>Pr√©stamo
    participant GA as Gestor<br/>Almacenamiento
    participant BD as BD<br/>Principal
    participant BR as BD<br/>R√©plica
    
    Note over PS,BR: üöÄ INICIALIZACI√ìN DEL SISTEMA
    
    rect rgb(230, 240, 255)
        Note over PS: Cargar archivo<br/>peticiones.txt
        Note over GC: Bind REP:5555<br/>Bind PUB:5556
        Note over AD: Subscribe<br/>"DEVOLUCION"
        Note over AR: Subscribe<br/>"RENOVACION"
        Note over AP: Bind REP:5559
        Note over GA: Iniciar pool<br/>conexiones BD
        Note over BD,BR: Ambas con<br/>1000 libros
    end
    
    Note over PS,BR: üì§ OPERACI√ìN 1: DEVOLUCI√ìN (AS√çNCRONA)
    
    rect rgb(255, 250, 245)
        PS->>GC: REQ: DEVOLUCION|LIB001|USR1001
        Note right of GC: Respuesta<br/>inmediata
        GC-->>PS: REP: OK "Biblioteca recibiendo libro"
        Note left of PS: Cliente libre<br/>~3ms
        
        GC->>AD: PUB: DEVOLUCION {datos}
        Note right of AD: Procesamiento<br/>as√≠ncrono
        
        AD->>GA: Solicitar UPDATE
        GA->>BD: UPDATE libros SET ejemplares+=1
        BD-->>GA: OK
        GA-->>AD: Confirmaci√≥n
        
        AD->>GA: INSERT historial
        GA->>BD: INSERT INTO historial_operaciones
        BD-->>GA: OK
        
        Note over GA,BR: Replicaci√≥n async
        GA->>BR: Replicar cambios
        BR-->>GA: ACK (async)
    end
    
    Note over PS,BR: üîÑ OPERACI√ìN 2: RENOVACI√ìN (AS√çNCRONA)
    
    rect rgb(245, 255, 245)
        PS->>GC: REQ: RENOVACION|LIB025|USR2002
        Note right of GC: Calcular<br/>nueva_fecha<br/>(+7 d√≠as)
        GC-->>PS: REP: OK "Nueva fecha: 2025-10-13"
        Note left of PS: Fecha recibida<br/>~3ms
        
        GC->>AR: PUB: RENOVACION {libro, nueva_fecha}
        
        AR->>GA: Solicitar UPDATE
        GA->>BD: UPDATE prestamos SET fecha_entrega, renovaciones+=1
        BD-->>GA: OK (si renovaciones<2)
        GA-->>AR: Confirmaci√≥n
        
        AR->>GA: INSERT historial
        GA->>BD: INSERT INTO historial_operaciones
        BD-->>GA: OK
        
        GA->>BR: Replicar cambios
        BR-->>GA: ACK (async)
    end
    
    Note over PS,BR: üîí OPERACI√ìN 3: PR√âSTAMO (S√çNCRONA)
    
    rect rgb(255, 245, 255)
        PS->>GC: REQ: PRESTAMO|LIB300|USR3001
        Note right of GC: Espera<br/>respuesta Actor
        
        GC->>AP: REQ: Verificar y otorgar LIB300
        
        AP->>GA: SELECT ejemplares_disponibles
        GA->>BD: SELECT FROM libros WHERE codigo='LIB300'
        BD-->>GA: ejemplares=2
        GA-->>AP: Disponibles: 2
        
        alt Libro disponible (ejemplares > 0)
            AP->>GA: BEGIN TRANSACTION
            GA->>BD: START TRANSACTION
            
            AP->>GA: UPDATE libros SET ejemplares-=1
            GA->>BD: UPDATE libros
            BD-->>GA: OK
            
            AP->>GA: INSERT prestamos (nuevo pr√©stamo)
            GA->>BD: INSERT INTO prestamos
            BD-->>GA: OK
            
            AP->>GA: INSERT historial
            GA->>BD: INSERT INTO historial_operaciones
            BD-->>GA: OK
            
            AP->>GA: COMMIT
            GA->>BD: COMMIT TRANSACTION
            BD-->>GA: Transacci√≥n exitosa
            GA-->>AP: Confirmaci√≥n
            
            Note over GA,BR: Replicar despu√©s<br/>de COMMIT
            GA->>BR: Replicar transacci√≥n completa
            BR-->>GA: ACK (async)
            
            AP-->>GC: REP: OK "Pr√©stamo otorgado"
            GC-->>PS: REP: OK "Fecha entrega: 2025-10-20"
            Note left of PS: BD actualizada<br/>~80ms
            
        else Sin ejemplares disponibles
            AP->>GA: No iniciar transacci√≥n
            AP-->>GC: REP: ERROR "Sin ejemplares"
            GC-->>PS: REP: ERROR "No disponible"
            Note left of PS: Rechazo<br/>~40ms
        end
    end
    
    Note over PS,BR: ‚ö†Ô∏è ESCENARIO DE FALLA: BD PRINCIPAL
    
    rect rgb(255, 240, 240)
        AD->>GA: Solicitar UPDATE
        GA->>BD: Intentar conexi√≥n
        Note right of BD: BD Principal<br/>NO RESPONDE
        BD--xGA: Connection timeout/refused
        
        Note over GA: Health Check<br/>detecta falla<br/>Activar FAILOVER
        
        GA->>GA: switch_to_replica()
        Note right of GA: GA configura<br/>BD R√©plica como<br/>primaria
        
        GA->>BR: Establecer nueva conexi√≥n
        BR-->>GA: Conexi√≥n OK (ahora es primaria)
        GA-->>AD: Conexi√≥n lista
        
        AD->>GA: Reintentar UPDATE
        GA->>BR: UPDATE libros
        BR-->>GA: OK
        GA-->>AD: Confirmaci√≥n
        
        Note over BD,BR: BD R√©plica ahora es PRINCIPAL<br/>BD Principal INACTIVA
        
        Note over BD: Cuando se recupere<br/>sincronizar desde<br/>R√©plica (ahora principal)
    end
    
    Note over PS,BR: üìä RESUMEN FINAL
    
    rect rgb(245, 245, 250)
        Note over PS: 3 operaciones enviadas:<br/>‚Ä¢ 1 Devoluci√≥n (3ms)<br/>‚Ä¢ 1 Renovaci√≥n (3ms)<br/>‚Ä¢ 1 Pr√©stamo (80ms)
        
        Note over GC: Routing de mensajes:<br/>‚Ä¢ REP inmediato (async)<br/>‚Ä¢ PUB a t√≥picos<br/>‚Ä¢ REQ/REP (sync)
        
        Note over AD,AR: Procesamiento async:<br/>‚Ä¢ No bloquea cliente<br/>‚Ä¢ BD actualizada despu√©s<br/>‚Ä¢ Multiple consumers
        
        Note over AP: Procesamiento sync:<br/>‚Ä¢ Cliente espera<br/>‚Ä¢ Transacci√≥n ACID<br/>‚Ä¢ Confirmaci√≥n inmediata
        
        Note over GA: Gesti√≥n de BD:<br/>‚Ä¢ Pool conexiones<br/>‚Ä¢ Health checks<br/>‚Ä¢ Failover autom√°tico
        
        Note over BD,BR: Replicaci√≥n:<br/>‚Ä¢ As√≠ncrona<br/>‚Ä¢ Eventual consistency<br/>‚Ä¢ Tolerancia a fallos
    end
